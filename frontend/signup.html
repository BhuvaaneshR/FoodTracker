<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - FoodTracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
    <style>
        body {
            background: linear-gradient(135deg, #e8f6ef 0%, #f8fbff 100%);
            min-height: 100vh;
            font-family: 'Inter', Arial, sans-serif;
        }
        .signup-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 2.5rem 2rem 2rem 2rem;
            margin-top: 3rem;
            margin-bottom: 2rem;
        }
        .signup-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1a3c34;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .form-label {
            font-weight: 600;
        }
        .btn-primary {
            background: #16a34a;
            border: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-radius: 8px;
        }
        .btn-primary:hover {
            background: #15803d;
        }
        .btn-success {
            font-weight: 600;
            border-radius: 8px;
        }
        .text-center a {
            color: #15803d;
            text-decoration: none;
            font-weight: 600;
        }
        .text-center a:hover {
            text-decoration: underline;
        }
        .criteria-box {
            border: 2px solid #dc3545;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8d7da;
            color: #721c24;
        }
        .criteria-box.valid {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }
        .criteria-list {
            margin-bottom: 0;
        }
        .criteria-list li.valid {
            color: #28a745;
        }
        .criteria-list li.invalid {
            color: #dc3545;
        }
        .match-message {
            font-size: 0.95em;
            margin-top: 5px;
        }
        .match-message.valid {
            color: #28a745;
        }
        .match-message.invalid {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 420px;">
        <div class="signup-card">
            <div class="signup-title">Sign Up</div>
            <form id="signupForm" class="mt-4">
                <div class="mb-3">
                    <label for="fullname" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="fullname" name="fullname" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Enter Password</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                    <div id="passwordCriteria" class="criteria-box mt-2">
                        <ul class="criteria-list list-unstyled mb-0">
                            <li id="length" class="invalid">At least 8 characters</li>
                            <li id="lowercase" class="invalid">At least 1 lowercase letter</li>
                            <li id="uppercase" class="invalid">At least 1 uppercase letter</li>
                            <li id="special" class="invalid">At least 1 special character</li>
                        </ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    <div id="matchMessage" class="match-message"></div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Create Account</button>
            </form>
            <form id="otpForm" class="mt-4" style="display:none;">
                <div class="mb-3">
                    <label for="otp" class="form-label">Enter OTP sent to your email</label>
                    <input type="text" class="form-control" id="otp" name="otp" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Verify OTP</button>
            </form>
            <div class="text-center mt-4">
                <p>Already have an account? <a href="login.html">Click here to login</a></p>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script>
        // EmailJS keys
        const EMAILJS_SERVICE_ID = 'service_xkplhvv';
        const EMAILJS_TEMPLATE_ID = 'template_h4nx0if';
        const EMAILJS_PUBLIC_KEY = 'Ey-md1IT-qMe10lXF';
        // OTP storage
        let generatedOTP = '';
        // Initialize EmailJS
        emailjs.init(EMAILJS_PUBLIC_KEY);

        // Password validation
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const criteriaBox = document.getElementById('passwordCriteria');
        const matchMessage = document.getElementById('matchMessage');
        const criteria = {
            length: false,
            lowercase: false,
            uppercase: false,
            special: false
        };

        function validatePasswordCriteria(password) {
            criteria.length = password.length >= 8;
            criteria.lowercase = /[a-z]/.test(password);
            criteria.uppercase = /[A-Z]/.test(password);
            criteria.special = /[^A-Za-z0-9]/.test(password);

            document.getElementById('length').className = criteria.length ? 'valid' : 'invalid';
            document.getElementById('lowercase').className = criteria.lowercase ? 'valid' : 'invalid';
            document.getElementById('uppercase').className = criteria.uppercase ? 'valid' : 'invalid';
            document.getElementById('special').className = criteria.special ? 'valid' : 'invalid';

            if (criteria.length && criteria.lowercase && criteria.uppercase && criteria.special) {
                criteriaBox.classList.add('valid');
                criteriaBox.classList.remove('invalid');
            } else {
                criteriaBox.classList.remove('valid');
                criteriaBox.classList.add('invalid');
            }
        }

        function validatePasswordMatch() {
            if (confirmPasswordInput.value === '') {
                matchMessage.textContent = '';
                matchMessage.className = 'match-message';
                return;
            }
            if (passwordInput.value === confirmPasswordInput.value) {
                matchMessage.textContent = 'Passwords match';
                matchMessage.className = 'match-message valid';
            } else {
                matchMessage.textContent = 'Passwords do not match';
                matchMessage.className = 'match-message invalid';
            }
        }

        passwordInput.addEventListener('input', function() {
            validatePasswordCriteria(passwordInput.value);
            validatePasswordMatch();
        });
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        document.getElementById('signupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // Validate all password criteria
            if (!(criteria.length && criteria.lowercase && criteria.uppercase && criteria.special)) {
                alert('Password does not meet all criteria!');
                return;
            }
            // Validate passwords match
            if (passwordInput.value !== confirmPasswordInput.value) {
                alert('Passwords do not match!');
                return;
            }
            // Generate OTP
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
            // Send OTP via EmailJS
            const email = document.getElementById('email').value;
            const fullname = document.getElementById('fullname').value;
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                to_email: email,
                to_name: fullname,
                passcode: generatedOTP // changed from 'otp' to 'passcode'
            }).then(function(response) {
                alert('OTP sent to your email!');
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('otpForm').style.display = 'block';
            }, function(error) {
                alert('Failed to send OTP. Please try again.');
            });
        });

        document.getElementById('otpForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const enteredOTP = document.getElementById('otp').value;
            if (enteredOTP === generatedOTP) {
                // Send signup data to backend
                const full_name = document.getElementById('fullname').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                fetch('http://localhost:5000/api/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ full_name, email, password })
                })
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(res => {
                    if (res.status === 201) {
                        alert('Account created successfully!');
                        window.location.href = 'login.html';
                    } else {
                        alert(res.body.error || 'Signup failed.');
                        // Optionally, reset forms to allow retry
                        document.getElementById('signupForm').style.display = 'block';
                        document.getElementById('otpForm').style.display = 'none';
                    }
                })
                .catch(() => {
                    alert('Error connecting to server.');
                });
            } else {
                alert('Invalid OTP. Please try again.');
            }
        });

        // Initial validation state
        validatePasswordCriteria('');

        console.log({
    to_email: email,
    to_name: fullname,
    passcode: generatedOTP
    });

    </script>
</body>
</html> 